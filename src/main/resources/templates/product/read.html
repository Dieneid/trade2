<div th:replace="~{layout/head}"></div>
<link rel="stylesheet" href="/css/read.css">
</head>
<div th:replace="layout/sidebar :: sidebar"></div>
<th:block th:replace="~{/layout/basic::setContent(~{this::content})}">
    <th:block th:fragment="content">
        <body>
        <div class="read-container">
            <!-- ÏÉÅÌíà Ï†ïÎ≥¥ ÏòÅÏó≠ -->
            <div class="product-details">
                <div class="product-info">
                    <div id="imageCarousel" class="carousel slide"
                         style="width: 300px; height: 300px; overflow: hidden; position: relative;">
                        <!-- Carousel inner -->
                        <div class="carousel-inner">
                            <!-- JavaScriptÎ°ú ÎèôÏ†ÅÏúºÎ°ú Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä -->
                        </div>
                        <!-- ÌåêÎß§ ÏòàÏïΩ Î†àÏù¥Ïñ¥ -->
                        <div id="RESERVED-overlay" class="RESERVED-overlay" style="display: none;">
                            <p>ÌåêÎß§ ÏòàÏïΩ</p>
                        </div>
                        <!-- ÌåêÎß§ ÏôÑÎ£å Î†àÏù¥Ïñ¥ -->
                        <div id="SOLDOUT-overlay" class="SOLDOUT-overlay" style="display: none;">
                            <p>ÌåêÎß§ ÏôÑÎ£å</p>
                        </div>
                        <!-- Left and Right Controls -->
                        <button id="carouselPrev" class="carousel-control-prev" type="button"
                                data-bs-target="#imageCarousel" data-bs-slide="prev" style="display: none;">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button id="carouselNext" class="carousel-control-next" type="button"
                                data-bs-target="#imageCarousel" data-bs-slide="next" style="display: none;">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>

                        <!-- Image Count -->
                        <div id="image-count"
                             style="position: absolute; bottom: 10px; right: 10px; background: rgba(0, 0, 0, 0.5); color: white; padding: 5px; border-radius: 5px;">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label>
                                <h2 th:text="${product.title}"
                                    style="font-size: 4rem; display: inline-block; margin-right: 10px;">ÏÉÅÌíàÎ™Ö</h2>


                                <th:block th:if="${authDTO == null}">
                                    <a href="javascript:void(0);" onclick="redirectToLogin();">
                                        <span style="display: inline-block; vertical-align: middle;">
                                            <img class="favorite-icon"
                                                 th:id="'fav-icon-' + ${product.productId}"
                                                 th:src="@{/images/notlike.png}"
                                                 alt="Ï∞ú ÏïÑÏù¥ÏΩò (Î°úÍ∑∏Ïù∏ ÌïÑÏöî)"
                                                 style="vertical-align: middle;"/>
                                        </span>
                                    </a>
                                </th:block>
                        <!-- Ï∞ú ÏïÑÏù¥ÏΩòÍ≥º Ïπ¥Ïö¥Ìä∏ -->
                        <th:block th:if="${authDTO != null}">
                            <th:block th:if="${favoriteStatusMap[product.productId] != null}">
                                    <span style="display: inline-block; vertical-align: middle;">
                                        <img class="favorite-icon liked"
                                             th:id="'fav-icon-' + ${product.productId}"
                                             th:src="@{${favoriteStatusMap[product.productId] ? '/images/like.png' : '/images/notlike.png'}}"
                                             th:onclick="'toggleFavorite(' + ${product.productId} + ',' + ${favoriteStatusMap[product.productId]} + ')'"
                                             alt="Ï∞ú ÏïÑÏù¥ÏΩò"
                                             style="vertical-align: middle;"/>
                                    </span>
                            </th:block>
                            <th:block th:if="${favoriteStatusMap[product.productId] == null}">
                                    <span style="display: inline-block; vertical-align: middle;">
                                        <img class="favorite-icon not-liked"
                                             th:id="'fav-icon-' + ${product.productId}"
                                             th:src="@{/images/notlike.png}"
                                             alt="Ï∞úÌïòÏßÄ ÏïäÏùå ÏïÑÏù¥ÏΩò"
                                             style="vertical-align: middle;"/>
                                    </span>
                            </th:block>
                        </th:block>
                            </label>
                        </div>
                        <div class="form-group">
                            </br>
                            <h2 id="sellPrice" th:text="${formattedSellPrice}+' Ïõê'" style="font-size: 3rem">Í∞ÄÍ≤©</h2>
                        </div>
                        <hr>

                        <div class="form-group">

                            <a th:href="${authDTO != null && authDTO.memberId == product.memberId} ? '/member/mypage' : '/member/memberpage/' + ${product.memberId}"
                               th:text="${product.memberName}"
                               th:attr="data-member-id=${product.memberId}">
                            </a>

                        </div>
                        <!-- Ï°∞ÌöåÏàò ÏïÑÏù¥ÏΩòÍ≥º Ïπ¥Ïö¥Ìä∏ -->
                        <div class="view-stat">
                            ‚ù§Ô∏è <span class="favorite-allCount" th:text="${product.favoriteCount}">0</span>
                            üëÅÔ∏è <span class="view-count" th:text="${product.viewCount}">0</span>
                            üïñ <span class="create-date" th:text="${#temporals.format(product.refreshedAt, 'yyyy-MM-dd HH:mm')}"></span>
                        </div>
                        <!-- ÏàòÏ†ïÌïòÍ∏∞, ÏÇ≠Ï†úÌïòÍ∏∞, ÎÅåÏò¨ Î≤ÑÌäºÏùÄ isOwnerÍ∞Ä trueÏùº ÎïåÎßå ÌëúÏãú -->
                        <div class="owner-actions" th:if="${isOwner}">
                            <a th:href="@{/product/edit/{productId}(productId=${product.productId})}"
                               class="btn btn-success">ÏàòÏ†ïÌïòÍ∏∞</a>
                            <form th:action="@{/product/delete/{productId}(productId=${product.productId})}"
                                  method="get"
                                  style="display: inline;">
                                <button type="submit" class="btn btn-danger" onclick="return confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')">
                                    ÏÇ≠Ï†úÌïòÍ∏∞
                                </button>
                            </form>

                            <form th:action="@{/product/read/{productId}(productId=${product.productId})}" method="post"
                                  style="display: inline;" th:if="${product.status != 'SOLDOUT'}">
                                <button type="submit" class="btn btn-warning">ÎÅåÏò¨</button>
                            </form>
                            <form th:action="@{/product/reserved/{productId}(productId=${product.productId})}"
                                  method="post"
                                  style="display: inline;" th:if="${product.status == 'NEW'}">
                                <button type="submit" class="btn btn-warning">ÌåêÎß§ ÏòàÏïΩ</button>
                            </form>
                            <form th:action="@{/product/reserved/{productId}(productId=${product.productId})}"
                                  method="post"
                                  style="display: inline;" th:if="${product.status == 'RESERVED'}">
                                <button type="submit" class="btn btn-warning">ÌåêÎß§ ÏòàÏïΩ Ï∑®ÏÜå</button>
                            </form>
                        </div>
                        <!-- Íµ¨Îß§ÌïòÍ∏∞ Î≤ÑÌäºÏùÄ isOwnerÍ∞Ä falseÏùº ÎïåÎßå ÌëúÏãú -->
                        <div class="buy-button a" th:if="${!isOwner and product.status == 'NEW'}">
                            <a th:href="@{/product/complete/{productId}(productId=${product.productId})}"
                               class="btn btn-primary">Íµ¨Îß§ÌïòÍ∏∞</a>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#chatModal"
                                    th:data-chat-room-id="${product.productId}"
                                    th:data-sender-id="${memberId}"
                                    th:data-receiver-id="${product.memberId}"
                                    th:data-sender-name="${memberName}"
                                    th:data-receiver-name="${product.memberName}"
                                    th:data-auth-dto="${authDTO}"
                                    id="openChatButton" th:if="${!isOwner}">
                                Ï±ÑÌåÖ
                            </button>
                        </div>
                    </div>
                </div>


                <hr style="color:black;">
                <p style="font-size: 1.8rem; margin-bottom: 10px;  padding-left: 20px;">ÏÉÅÌíà Ï†ïÎ≥¥</p>
                <div class="description-container" style="margin-top:0;">
                    <div class="form-group">
                        <p th:text="${product.description}">ÏÉÅÌíà Ï†ïÎ≥¥</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="back-button">
            <a th:href="@{/product/list}" class="btn btn-secondary">Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</a>
        </div>


        <!-- Ï±ÑÌåÖ Î™®Îã¨ -->
        <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="chatModalLabel">1:1 Ï±ÑÌåÖÎ∞©</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="chat-box">
                            <div id="messages" class="messages" style="height: 300px; overflow-y: auto;"></div>
                        </div>
                        <div class="message-box">
                            <textarea id="messageContent" class="form-control" rows="2" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                      required></textarea>
                            <button id="sendMessage" class="message-submit" onclick="sendMessage()">Ï†ÑÏÜ°</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        </body>
    </th:block>
</th:block>
<div th:replace="layout/footer :: footer"></div>
<script>
    let currentRoomId = null;
    let senderId = null;
    let receiverId = null;
    let senderName = null;
    let receiverName = null;
    let stompClient = null;

    // Î™®Îã¨Ïù¥ Ïó¥Î¶¨Î©¥ Ï±ÑÌåÖÎ∞© ID ÏÑ§Ï†ï
    $('#chatModal').on('shown.bs.modal', function (event) {
        const button = document.getElementById('openChatButton');  // Î™®Îã¨ÏùÑ Ïó¨Îäî Î≤ÑÌäº
        const productId = button.getAttribute('data-chat-room-id');  // Î≤ÑÌäºÏóêÏÑú ÏÉÅÌíà ID Í∞ÄÏ†∏Ïò§Í∏∞
        senderId = button.getAttribute('data-sender-id');
        receiverId = button.getAttribute('data-receiver-id');
        senderName = button.getAttribute('data-sender-name');
        receiverName = button.getAttribute('data-receiver-name');
        const authDTO = button.getAttribute('data-auth-dto'); // authDTO Í∞ÄÏ†∏Ïò§Í∏∞

        // authDTOÍ∞Ä nullÏù∏ÏßÄ ÌôïÏù∏
        if (!authDTO) {
            window.location.href = "/member/login"; // Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Î¶¨ÎîîÎ†âÏÖò
            return; // Ï∂îÍ∞Ä ÏûëÏóÖ Ï§ëÎã®
        }

        console.log('productId:', productId);

        const chatModalLabel = document.getElementById('chatModalLabel');
        chatModalLabel.textContent = `${receiverName}ÎãòÍ≥ºÏùò Ï±ÑÌåÖ`;
        if (!productId) {
            alert("ÏÉÅÌíàÏù¥ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.");
            return;
        }

        // ÏÉÅÌíà IDÎ•º ÏÇ¨Ïö©Ìï¥ Ï±ÑÌåÖÎ∞© IDÎ•º ÏÑúÎ≤ÑÏóêÏÑú Í∞ÄÏ†∏ÏòµÎãàÎã§.
        fetch(`/chat/chatRoom/${productId}`)  // URL Í≤ΩÎ°ú ÏàòÏ†ï
            .then(response => response.json())
            .then(data => {
                const chatRoomId = data.chatRoomId;
                if (!chatRoomId) {
                    alert("Ï±ÑÌåÖÎ∞©ÏùÑ ÏÉùÏÑ±Ìï† Ïàò ÏóÜÏäµÎãàÎã§.");
                    return;
                }

                // Ï±ÑÌåÖÎ∞© ID ÏÑ§Ï†ï
                currentRoomId = chatRoomId;

                // Ï±ÑÌåÖÎ∞© Î©îÏãúÏßÄ Î∂àÎü¨Ïò§Í∏∞
                loadMessages(currentRoomId);

                // WebSocket Ï¥àÍ∏∞Ìôî Î∞è Ïó∞Í≤∞
                initializeWebSocket(currentRoomId);
            })
            .catch(error => {
                console.error('Ï±ÑÌåÖÎ∞© Ï†ïÎ≥¥ Î∂àÎü¨Ïò§Í∏∞ Ïò§Î•ò:', error);
                alert("Ï±ÑÌåÖÎ∞©ÏùÑ Î∂àÎü¨Ïò§Îäî Îç∞ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
            });
    });

    let memberId = [[${product.memberId}]];
    // Ï±ÑÌåÖÎ∞© Î©îÏãúÏßÄ Î∂àÎü¨Ïò§Í∏∞
    function loadMessages(chatRoomId) {
        console.log("Loading messages for chatRoomId:", chatRoomId);
        fetch(`/chat/messages/${chatRoomId}`)
            .then(response => {
                if (!response.ok) {
                    // ÏÑúÎ≤Ñ ÏùëÎãµÏù¥ 200Î≤àÎåÄÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞
                    throw new Error(`ÏÑúÎ≤Ñ Ïò§Î•ò: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.messages) {
                    const messageListContainer = document.getElementById('messages');
                    messageListContainer.innerHTML = ''; // Í∏∞Ï°¥ Î©îÏãúÏßÄ Ï¥àÍ∏∞Ìôî

                    data.messages.forEach(message => {
                        const messageItem = document.createElement('div');
                        messageItem.classList.add(
                            'message',
                            message.senderId === memberId ? 'sent' : 'received'
                        );
                        messageItem.innerHTML = `
                            <p>${message.content}</p>
                            <span class="message-timestamp">${new Date(message.createdAt).toLocaleString()}</span>
                        `;
                        messageListContainer.appendChild(messageItem);
                    });

                    // Î©îÏãúÏßÄ Î°úÎìú ÌõÑ Ïä§ÌÅ¨Î°§ Ïù¥Îèô
                    setTimeout(() => {
                        messageListContainer.scrollTop = messageListContainer.scrollHeight;
                    }, 100);
                } else {
                    console.error('No messages found in the response.');
                    alert('Î©îÏãúÏßÄÎ•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. (Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå)');
                }
            })
            .catch(error => {
                console.error('Error loading messages:', error);
                alert(`Î©îÏãúÏßÄÎ•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`);
            });
    }

    // ÏÉàÎ°úÏö¥ Î©îÏãúÏßÄ ÌëúÏãú
    function displayNewMessage(message) {
        const messageListContainer = document.getElementById('messages');
        const messageItem = document.createElement('div');
        messageItem.classList.add(
            'message',
            message.senderId === memberId ? 'sent' : 'received'
        );
        messageItem.innerHTML = `
           <p>${message.content}</p>
           <span class="message-timestamp">${new Date(message.createdAt).toLocaleString()}</span>
        `;
        messageListContainer.appendChild(messageItem);

        // Ïä§ÌÅ¨Î°§ÏùÑ ÎßàÏßÄÎßâ Î©îÏãúÏßÄÎ°ú Ïù¥Îèô
        messageListContainer.scrollTop = messageListContainer.scrollHeight;
    }

    // Î©îÏãúÏßÄ Ï†ÑÏÜ° Ìï®Ïàò
    function sendMessage() {
        const messageContent = document.getElementById('messageContent').value.trim();
        const messageListContainer = document.getElementById('messages'); // Î©îÏãúÏßÄ Î¶¨Ïä§Ìä∏
        if (!messageContent || !messageListContainer) {
            console.error('Required input or message list element not found.');
            return;
        }

        if (!messageContent) {
            alert("Î©îÏãúÏßÄÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
            return;
        }
        if (!currentRoomId) {  // currentRoomIdÍ∞Ä nullÏù∏ Í≤ΩÏö∞
            alert("Ï±ÑÌåÖÎ∞©Ïù¥ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.");
            return;
        }
        // Ï†ÑÏÜ°Ìï† Î©îÏãúÏßÄ Îç∞Ïù¥ÌÑ∞
        const messageData = {
            content: messageContent,
            chatRoomId: currentRoomId,
            senderId: senderId,          // Î°úÍ∑∏Ïù∏Îêú ÏÇ¨Ïö©ÏûêÏùò ID
            receiverId: receiverId,        // ÏÉÅÌíà ÏÜåÏú†ÏûêÏùò ID
            senderName: senderName,      // Î°úÍ∑∏Ïù∏Îêú ÏÇ¨Ïö©ÏûêÏùò Ïù¥Î¶Ñ
            receiverName: receiverName,    // ÏÉÅÌíà ÏÜåÏú†ÏûêÏùò Ïù¥Î¶Ñ
            createdAt: new Date().toISOString(), // ÌòÑÏû¨ ÏãúÍ∞Ñ
            status: 'UNREAD'                       // Î©îÏãúÏßÄÎäî ÏùΩÏßÄ ÏïäÏùÄ ÏÉÅÌÉúÎ°ú ÏÑ§Ï†ï
        };

        stompClient.send('/pub/chat/send/chatRoom', {}, JSON.stringify(messageData));

        // UI ÏóÖÎç∞Ïù¥Ìä∏ (Î≥¥ÎÇ∏ Î©îÏãúÏßÄ ÌëúÏãú)
        const messageItem = document.createElement('div');
        messageContent.value = ''; // ÏûÖÎ†•Ï∞Ω Ï¥àÍ∏∞Ìôî
        messageListContainer.scrollTop = messageListContainer.scrollHeight; // ÎßàÏßÄÎßâ Î©îÏãúÏßÄÎ°ú Ïä§ÌÅ¨Î°§
    }

    // Ï±ÑÌåÖÎ∞©Ïùò ÏÉÅÎåÄÎ∞© ID Î∞òÌôò
    function getReceiverIdForRoom(chatRoomId) {
        const roomData = chatRoomData.find(room => room.chatRoomId === chatRoomId);
        return roomData ? (roomData.senderId === memberId ? roomData.receiverId : roomData.senderId) : null;
    }

    // Ï±ÑÌåÖÎ∞©Ïùò ÏÉÅÎåÄÎ∞© Ïù¥Î¶Ñ Î∞òÌôò
    function getReceiverNameForRoom(chatRoomId) {
        const roomData = chatRoomData.find(room => room.chatRoomId === chatRoomId);
        return roomData ? (roomData.senderId === memberId ? roomData.receiverName : roomData.senderName) : null;
    }

    // WebSocket Ï¥àÍ∏∞Ìôî Î∞è Î©îÏãúÏßÄ ÏàòÏã† Ï≤òÎ¶¨
    function initializeWebSocket(chatRoomId) {
        if (stompClient && stompClient.connected) {
            stompClient.subscribe(`/sub/chat/${chatRoomId}`, function (messageOutput) {
                const message = JSON.parse(messageOutput.body);
                if (message.chatRoomId === currentRoomId) {
                    displayNewMessage(message);
                }
            });
            return;
        }
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            stompClient.subscribe(`/sub/chat/${chatRoomId}`, function (messageOutput) {
                const message = JSON.parse(messageOutput.body);
                if (message.chatRoomId === currentRoomId) {
                    displayNewMessage(message);
                }
            });
        });
    }
</script>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
            let productId = /*[[${product.productId}]]*/ 0; // Ï†úÌíà ID
            let images = /*[[${images}]]*/ []; // Ïù¥ÎØ∏ÏßÄ Î∞∞Ïó¥
            let carouselInner = document.querySelector('#imageCarousel .carousel-inner');
            let imageCountElement = document.getElementById('image-count');
            let prevButton = document.getElementById('carouselPrev');
            let nextButton = document.getElementById('carouselNext');
            let soldoutOverlay = document.getElementById('SOLDOUT-overlay');
            let resevedOverlay = document.getElementById('RESERVED-overlay');
            let csrfToken = document.querySelector('meta[name="_csrf"]').content;
            let status = /*[[${product.status}]]*/ 'NEW'; // ÏÑúÎ≤ÑÏóêÏÑú Ï†ÑÎã¨Îêú ÏÉÅÌÉúÍ∞í
            // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
            function updateSoldoutStatus(status) {
                if (!soldoutOverlay) {
                    console.error("soldoutOverlay ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
                    return;
                }

                if (status == 'SOLDOUT') {
                    soldoutOverlay.style.display = 'flex'; // ÌåêÎß§ ÏôÑÎ£å Î¨∏Íµ¨ ÌëúÏãú
                    document.querySelectorAll('.carousel-inner img').forEach(img => {
                        img.classList.add('SOLDOUT');
                    });
                } else {
                    soldoutOverlay.style.display = 'none'; // ÌåêÎß§ ÏôÑÎ£å Î¨∏Íµ¨ Ïà®Í∏∞Í∏∞
                    document.querySelectorAll('.carousel-inner img').forEach(img => {
                        img.classList.remove('SOLDOUT');
                    });
                }
                if (status === 'RESERVED') {
                    resevedOverlay.style.display = 'flex'; // ÌåêÎß§ ÏòàÏïΩ Î¨∏Íµ¨ ÌëúÏãú
                    document.querySelectorAll('.carousel-inner img').forEach(img => {
                        img.classList.add('RESERVED');
                    });
                } else {
                    resevedOverlay.style.display = 'none'; // ÌåêÎß§ ÏòàÏïΩ Î¨∏Íµ¨ Ïà®Í∏∞Í∏∞
                    document.querySelectorAll('.carousel-inner img').forEach(img => {
                        img.classList.remove('RESERVED');
                    });
                }
            }

            // ÌåêÎß§ ÏòàÏïΩ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú ÏÉÅÌÉú Î≥ÄÍ≤Ω (RESERVED <-> NEW)
            document.querySelector('#reserveButton')?.addEventListener('click', function () {
                let currentStatus = status; // ÌòÑÏû¨ ÏÉÅÌÉú

                if (currentStatus === 'RESERVED') {
                    // ÏÉÅÌÉúÎ•º 'NEW'Î°ú Î≥ÄÍ≤ΩÌïòÍ≥† ÏÑúÎ≤ÑÏóê Ï†ÑÎã¨
                    status = 'NEW';
                    updateSoldoutStatus(status); // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò Ìò∏Ï∂ú

                    // Ïó¨Í∏∞ÏÑú ÏÑúÎ≤ÑÏóê ÏÉÅÌÉú Î≥ÄÍ≤Ω ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇº Ïàò ÏûàÏäµÎãàÎã§
                    // ÏòàÏãú: fetch('/product/updateStatus', { method: 'POST', body: { status: 'NEW' } });
                } else if (currentStatus === 'NEW') {
                    // ÏÉÅÌÉúÎ•º 'RESERVED'Î°ú Î≥ÄÍ≤ΩÌïòÍ≥† ÏÑúÎ≤ÑÏóê Ï†ÑÎã¨
                    status = 'RESERVED';
                    updateSoldoutStatus(status); // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò Ìò∏Ï∂ú

                    // Ïó¨Í∏∞ÏÑú ÏÑúÎ≤ÑÏóê ÏÉÅÌÉú Î≥ÄÍ≤Ω ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇº Ïàò ÏûàÏäµÎãàÎã§
                    // ÏòàÏãú: fetch('/product/updateStatus', { method: 'POST', body: { status: 'RESERVED' } });
                }
            });
            updateSoldoutStatus(status);

            // Ïù¥ÎØ∏ÏßÄ Í∞ØÏàò ÏóÖÎç∞Ïù¥Ìä∏
            function updateImageCount(currentIndex) {
                if (images.length > 0) {
                    imageCountElement.textContent = `${currentIndex + 1} / ${images.length}`;
                } else {
                    imageCountElement.textContent = "Ïù¥ÎØ∏ÏßÄÍ∞Ä Îì±Î°ùÎêòÏñ¥ ÏûàÏßÄ ÏïäÏäµÎãàÎã§.";
                }
            }

            // Ïπ¥Î°úÏÖÄÏóê Ïù¥ÎØ∏ÏßÄ Ï±ÑÏö∞Í∏∞
            function populateCarousel() {
                carouselInner.innerHTML = "";
                prevButton.style.display = 'none';
                nextButton.style.display = 'none';

                if (images.length > 0) {
                    images.forEach((image, index) => {
                        const carouselItem = document.createElement("div");
                        carouselItem.className = `carousel-item ${index === 0 ? "active" : ""}`;
                        carouselItem.innerHTML = `<img src="/product/display?fileName=${image.imgName}" alt="Ïù¥ÎØ∏ÏßÄ ${index + 1}" style="width: 300px; height: 300px;">`;
                        carouselInner.appendChild(carouselItem);
                    });

                    updateImageCount(0); // Ï¥àÍ∏∞ Ïπ¥Ïö¥Ìä∏ ÏÑ§Ï†ï

                    if (images.length > 1) {
                        prevButton.style.display = 'block';
                        nextButton.style.display = 'block';
                    }
                } else {
                    const carouselItem = document.createElement("div");
                    carouselItem.className = "carousel-item active";
                    carouselItem.innerHTML = `<img src="/images/default.png" class="d-block w-100" alt="Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄ" style="width: 100%; height: 100%;">`;
                    carouselInner.appendChild(carouselItem);

                    updateImageCount(0);
                }

                // Ïπ¥Î°úÏÖÄ Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω Ïù¥Î≤§Ìä∏Ïóê Ìï∏Îì§Îü¨ Ï∂îÍ∞Ä
                const carouselElement = document.querySelector("#imageCarousel");
                carouselElement.addEventListener("slid.bs.carousel", function (event) {
                    const activeIndex = Array.from(carouselInner.children).findIndex(item => item.classList.contains("active"));
                    updateImageCount(activeIndex);
                });
            }

            let buyButton = document.querySelector('.buy-button a');
            if (buyButton) {
                buyButton.addEventListener('click', function (e) {
                    e.preventDefault(); // Í∏∞Î≥∏ ÎßÅÌÅ¨ ÌÅ¥Î¶≠ ÎèôÏûë Î∞©ÏßÄ

                    // Î°úÍ∑∏Ïù∏ Ïó¨Î∂Ä ÌôïÏù∏
                    fetch('/check-login', { // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÎäî ÏóîÎìúÌè¨Ïù∏Ìä∏
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    })
                        .then(response => response.json())
                        .then(data => {
                            let url1 = '/member/login';
                            // Î°úÍ∑∏Ïù∏ Îêú Í≤ΩÏö∞ÏóêÎßå Íµ¨Îß§ ÏôÑÎ£å Ï≤òÎ¶¨
                            let url = '/product/complete/' + productId;
                            fetch(url, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRF-TOKEN': csrfToken,  // CSRF ÌÜ†ÌÅ∞ Ï∂îÍ∞Ä
                                },
                            })
                                .then(response => response.json()) // JSON ÏùëÎãµ Ï≤òÎ¶¨
                                .then(data => {
                                    if (data.status === 'success') {
                                        alert(data.message);
                                        updateSoldoutStatus(true);  // ÌåêÎß§ ÏôÑÎ£å ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤Ω
                                        // Íµ¨Îß§ ÏôÑÎ£å ÌõÑ Ìï¥Îãπ URLÎ°ú Ïù¥Îèô
                                        window.location.href = url;
                                    } else {
                                        alert(data.message);
                                    }
                                })
                                .catch(error => {
                                    window.location.href = url1;
                                });
                        })
                        .catch(error => {
                            console.error('Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏ Ïò§Î•ò:', error);
                            alert('Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                        });
                    window.location.href = url1;
                });
            }


            populateCarousel();  // Ïπ¥Î°úÏÖÄ Ïù¥ÎØ∏ÏßÄ Ï¥àÍ∏∞Ìôî
        }
    );

        // Î°úÍ∑∏Ïù∏ Ïó¨Î∂ÄÎ•º ÌôïÏù∏ÌïòÎäî Î≥ÄÏàò Ï†ïÏùò
    let isLoggedIn = /*[[${authDTO != null}]]*/ true;

    function toggleFavorite(productId, isFavorited) {
        if (!isLoggedIn) {
            alert("Î°úÍ∑∏Ïù∏ ÌõÑ Ï∞ú Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.");
            return;  // Î°úÍ∑∏Ïù∏ÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ Í∏∞Îä• Ïã§Ìñâ Ï§ëÏßÄ
        }

        if (isFavorited == null) {
            isFavorited = false;  // Í∏∞Î≥∏Í∞í Ï≤òÎ¶¨
        }

        let url = '/product/favorite/' + productId; // Ï∞ú ÏÉÅÌÉú ÌÜ†Í∏ÄÏùÑ ÏúÑÌïú ÎèôÏùºÌïú ÏóîÎìúÌè¨Ïù∏Ìä∏

        console.log("URL to fetch: " + url);  // ÏöîÏ≤≠ URL ÌôïÏù∏

        // CSRF ÌÜ†ÌÅ∞ÏùÑ meta ÌÉúÍ∑∏ÏóêÏÑú ÏùΩÏñ¥Ïò§Í∏∞
        let csrfToken = document.querySelector('meta[name="_csrf"]').content;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrfToken,  // CSRF ÌÜ†ÌÅ∞ Ï∂îÍ∞Ä
            },
        })
            .then(response => response.json())
            .then(data => {
                const icon = document.getElementById('fav-icon-' + productId);
                const count = document.querySelector(`#fav-icon-${productId} + span`);

                // Ï∞ú ÏÉÅÌÉúÏóê Îî∞Îùº ÌïòÌä∏ ÏïÑÏù¥ÏΩò Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω
                if (data.isFavorited) {
                    icon.src = '/images/like.png';  // Ï∞ú ÏÉÅÌÉúÏùº Îïå
                } else {
                    icon.src = '/images/notlike.png';  // Ï∞úÌïòÏßÄ ÏïäÏïòÏùÑ Îïå
                }
                // Ï∞úÌïú ÏÇ¨Ïö©Ïûê Ïàò Í∞±Ïã†
                count.textContent = data.favoriteCount;

                console.log('Response Data:', data); // ÏÑúÎ≤Ñ ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
</script>
</html>
