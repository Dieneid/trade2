<div th:replace="~{layout/head}"></div>
<link rel="stylesheet" href="/css/read.css">
</head>
<div th:replace="layout/sidebar :: sidebar"></div>
<th:block th:replace="~{/layout/basic::setContent(~{this::content})}">
    <th:block th:fragment="content">
        <body>
        <div class="read-container">
            <!-- ìƒí’ˆ ì •ë³´ ì˜ì—­ -->
            <div class="product-details">
                <div class="product-info">
                    <div id="imageCarousel" class="carousel slide"
                         style="width: 300px; height: 300px; overflow: hidden; position: relative;">
                        <!-- Carousel inner -->
                        <div class="carousel-inner">
                            <!-- JavaScriptë¡œ ë™ì ìœ¼ë¡œ ì´ë¯¸ì§€ ì¶”ê°€ -->
                        </div>
                        <!-- íŒë§¤ ì˜ˆì•½ ë ˆì´ì–´ -->
                        <div id="RESERVED-overlay" class="RESERVED-overlay" style="display: none;">
                            <p>íŒë§¤ ì˜ˆì•½</p>
                        </div>
                        <!-- íŒë§¤ ì™„ë£Œ ë ˆì´ì–´ -->
                        <div id="SOLDOUT-overlay" class="SOLDOUT-overlay" style="display: none;">
                            <p>íŒë§¤ ì™„ë£Œ</p>
                        </div>
                        <!-- Left and Right Controls -->
                        <button id="carouselPrev" class="carousel-control-prev" type="button"
                                data-bs-target="#imageCarousel" data-bs-slide="prev" style="display: none;">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button id="carouselNext" class="carousel-control-next" type="button"
                                data-bs-target="#imageCarousel" data-bs-slide="next" style="display: none;">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>

                        <!-- Image Count -->
                        <div id="image-count"
                             style="position: absolute; bottom: 10px; right: 10px; background: rgba(0, 0, 0, 0.5); color: white; padding: 5px; border-radius: 5px;">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label>
                                <h2 th:text="${product.title}"
                                    style="font-size: 4rem; display: inline-block; margin-right: 10px;">ìƒí’ˆëª…</h2>


                                <th:block th:if="${authDTO == null}">
                                    <a href="javascript:void(0);" onclick="redirectToLogin();">
                                        <span style="display: inline-block; vertical-align: middle;">
                                            <img class="favorite-icon"
                                                 th:id="'fav-icon-' + ${product.productId}"
                                                 th:src="@{/images/notlike.png}"
                                                 alt="ì°œ ì•„ì´ì½˜ (ë¡œê·¸ì¸ í•„ìš”)"
                                                 style="vertical-align: middle;"/>
                                        </span>
                                    </a>
                                </th:block>
                        <!-- ì°œ ì•„ì´ì½˜ê³¼ ì¹´ìš´íŠ¸ -->
                        <th:block th:if="${authDTO != null}">
                            <th:block th:if="${favoriteStatusMap[product.productId] != null}">
                                    <span style="display: inline-block; vertical-align: middle;">
                                        <img class="favorite-icon liked"
                                             th:id="'fav-icon-' + ${product.productId}"
                                             th:src="@{${favoriteStatusMap[product.productId] ? '/images/like.png' : '/images/notlike.png'}}"
                                             th:onclick="'toggleFavorite(' + ${product.productId} + ',' + ${favoriteStatusMap[product.productId]} + ')'"
                                             alt="ì°œ ì•„ì´ì½˜"
                                             style="vertical-align: middle;"/>
                                    </span>
                            </th:block>
                            <th:block th:if="${favoriteStatusMap[product.productId] == null}">
                                    <span style="display: inline-block; vertical-align: middle;">
                                        <img class="favorite-icon not-liked"
                                             th:id="'fav-icon-' + ${product.productId}"
                                             th:src="@{/images/notlike.png}"
                                             alt="ì°œí•˜ì§€ ì•ŠìŒ ì•„ì´ì½˜"
                                             style="vertical-align: middle;"/>
                                    </span>
                            </th:block>
                        </th:block>
                            </label>
                        </div>
                        <div class="form-group">
                            </br>
                            <h2 id="sellPrice" th:text="${formattedSellPrice}+' ì›'" style="font-size: 3rem">ê°€ê²©</h2>
                        </div>
                        <hr>

                        <div class="form-group">

                            <a th:href="${authDTO != null && authDTO.memberId == product.memberId} ? '/member/mypage' : '/member/memberpage/' + ${product.memberId}"
                               th:text="${product.memberName}"
                               th:attr="data-member-id=${product.memberId}">
                            </a>

                        </div>
                        <!-- ì¡°íšŒìˆ˜ ì•„ì´ì½˜ê³¼ ì¹´ìš´íŠ¸ -->
                        <div class="view-stat">
                            â¤ï¸ <span class="favorite-allCount" th:text="${product.favoriteCount}">0</span>
                            ğŸ‘ï¸ <span class="view-count" th:text="${product.viewCount}">0</span>
                            ğŸ•– <span class="create-date" th:text="${#temporals.format(product.refreshedAt, 'yyyy-MM-dd HH:mm')}"></span>
                        </div>
                        <!-- ìˆ˜ì •í•˜ê¸°, ì‚­ì œí•˜ê¸°, ëŒì˜¬ ë²„íŠ¼ì€ isOwnerê°€ trueì¼ ë•Œë§Œ í‘œì‹œ -->
                        <div class="owner-actions" th:if="${isOwner}">
                            <a th:href="@{/product/edit/{productId}(productId=${product.productId})}"
                               class="btn btn-success">ìˆ˜ì •í•˜ê¸°</a>
                            <form th:action="@{/product/delete/{productId}(productId=${product.productId})}"
                                  method="get"
                                  style="display: inline;">
                                <button type="submit" class="btn btn-danger" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                                    ì‚­ì œí•˜ê¸°
                                </button>
                            </form>

                            <form th:action="@{/product/read/{productId}(productId=${product.productId})}" method="post"
                                  style="display: inline;" th:if="${product.status != 'SOLDOUT'}">
                                <button type="submit" class="btn btn-warning">ëŒì˜¬</button>
                            </form>
                            <form th:action="@{/product/reserved/{productId}(productId=${product.productId})}"
                                  method="post"
                                  style="display: inline;" th:if="${product.status == 'NEW'}">
                                <button type="submit" class="btn btn-warning">íŒë§¤ ì˜ˆì•½</button>
                            </form>
                            <form th:action="@{/product/reserved/{productId}(productId=${product.productId})}"
                                  method="post"
                                  style="display: inline;" th:if="${product.status == 'RESERVED'}">
                                <button type="submit" class="btn btn-warning">íŒë§¤ ì˜ˆì•½ ì·¨ì†Œ</button>
                            </form>
                        </div>
                        <!-- êµ¬ë§¤í•˜ê¸° ë²„íŠ¼ì€ isOwnerê°€ falseì¼ ë•Œë§Œ í‘œì‹œ -->
                        <div class="buy-button a" th:if="${!isOwner and product.status == 'NEW'}">
                            <a th:href="@{/product/complete/{productId}(productId=${product.productId})}"
                               class="btn btn-primary">êµ¬ë§¤í•˜ê¸°</a>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#chatModal"
                                    th:data-chat-room-id="${product.productId}"
                                    th:data-sender-id="${memberId}"
                                    th:data-receiver-id="${product.memberId}"
                                    th:data-sender-name="${memberName}"
                                    th:data-receiver-name="${product.memberName}"
                                    th:data-auth-dto="${authDTO}"
                                    id="openChatButton" th:if="${!isOwner}">
                                ì±„íŒ…
                            </button>
                        </div>
                    </div>
                </div>


                <hr style="color:black;">
                <p style="font-size: 1.8rem; margin-bottom: 10px;  padding-left: 20px;">ìƒí’ˆ ì •ë³´</p>
                <div class="description-container" style="margin-top:0;">
                    <div class="form-group">
                        <p th:text="${product.description}">ìƒí’ˆ ì •ë³´</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="back-button">
            <a th:href="@{/product/list}" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>


        <!-- ì±„íŒ… ëª¨ë‹¬ -->
        <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="chatModalLabel">1:1 ì±„íŒ…ë°©</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="chat-box">
                            <div id="messages" class="messages" style="height: 300px; overflow-y: auto;"></div>
                        </div>
                        <div class="message-box">
                            <textarea id="messageContent" class="form-control" rows="2" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                      required></textarea>
                            <button id="sendMessage" class="message-submit" onclick="sendMessage()">ì „ì†¡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        </body>
    </th:block>
</th:block>
<div th:replace="layout/footer :: footer"></div>
<script>
    let currentRoomId = null;
    let senderId = null;
    let receiverId = null;
    let senderName = null;
    let receiverName = null;
    let stompClient = null;

    // ëª¨ë‹¬ì´ ì—´ë¦¬ë©´ ì±„íŒ…ë°© ID ì„¤ì •
    $('#chatModal').on('shown.bs.modal', function (event) {
        const button = document.getElementById('openChatButton');  // ëª¨ë‹¬ì„ ì—¬ëŠ” ë²„íŠ¼
        const productId = button.getAttribute('data-chat-room-id');  // ë²„íŠ¼ì—ì„œ ìƒí’ˆ ID ê°€ì ¸ì˜¤ê¸°
        senderId = button.getAttribute('data-sender-id');
        receiverId = button.getAttribute('data-receiver-id');
        senderName = button.getAttribute('data-sender-name');
        receiverName = button.getAttribute('data-receiver-name');
        const authDTO = button.getAttribute('data-auth-dto'); // authDTO ê°€ì ¸ì˜¤ê¸°

        // authDTOê°€ nullì¸ì§€ í™•ì¸
        if (!authDTO) {
            window.location.href = "/member/login"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
            return; // ì¶”ê°€ ì‘ì—… ì¤‘ë‹¨
        }

        console.log('productId:', productId);

        const chatModalLabel = document.getElementById('chatModalLabel');
        chatModalLabel.textContent = `${receiverName}ë‹˜ê³¼ì˜ ì±„íŒ…`;
        if (!productId) {
            alert("ìƒí’ˆì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }

        // ìƒí’ˆ IDë¥¼ ì‚¬ìš©í•´ ì±„íŒ…ë°© IDë¥¼ ì„œë²„ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        fetch(`/chat/chatRoom/${productId}`)  // URL ê²½ë¡œ ìˆ˜ì •
            .then(response => response.json())
            .then(data => {
                const chatRoomId = data.chatRoomId;
                if (!chatRoomId) {
                    alert("ì±„íŒ…ë°©ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                // ì±„íŒ…ë°© ID ì„¤ì •
                currentRoomId = chatRoomId;

                // ì±„íŒ…ë°© ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
                loadMessages(currentRoomId);

                // WebSocket ì´ˆê¸°í™” ë° ì—°ê²°
                initializeWebSocket(currentRoomId);
            })
            .catch(error => {
                console.error('ì±„íŒ…ë°© ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
                alert("ì±„íŒ…ë°©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    });

    let memberId = [[${product.memberId}]];
    // ì±„íŒ…ë°© ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadMessages(chatRoomId) {
        console.log("Loading messages for chatRoomId:", chatRoomId);
        fetch(`/chat/messages/${chatRoomId}`)
            .then(response => {
                if (!response.ok) {
                    // ì„œë²„ ì‘ë‹µì´ 200ë²ˆëŒ€ê°€ ì•„ë‹Œ ê²½ìš°
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.messages) {
                    const messageListContainer = document.getElementById('messages');
                    messageListContainer.innerHTML = ''; // ê¸°ì¡´ ë©”ì‹œì§€ ì´ˆê¸°í™”

                    data.messages.forEach(message => {
                        const messageItem = document.createElement('div');
                        messageItem.classList.add(
                            'message',
                            message.senderId === memberId ? 'sent' : 'received'
                        );
                        messageItem.innerHTML = `
                            <p>${message.content}</p>
                            <span class="message-timestamp">${new Date(message.createdAt).toLocaleString()}</span>
                        `;
                        messageListContainer.appendChild(messageItem);
                    });

                    // ë©”ì‹œì§€ ë¡œë“œ í›„ ìŠ¤í¬ë¡¤ ì´ë™
                    setTimeout(() => {
                        messageListContainer.scrollTop = messageListContainer.scrollHeight;
                    }, 100);
                } else {
                    console.error('No messages found in the response.');
                    alert('ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ë°ì´í„° ì—†ìŒ)');
                }
            })
            .catch(error => {
                console.error('Error loading messages:', error);
                alert(`ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            });
    }

    // ìƒˆë¡œìš´ ë©”ì‹œì§€ í‘œì‹œ
    function displayNewMessage(message) {
        const messageListContainer = document.getElementById('messages');
        const messageItem = document.createElement('div');
        messageItem.classList.add(
            'message',
            message.senderId === memberId ? 'sent' : 'received'
        );
        messageItem.innerHTML = `
           <p>${message.content}</p>
           <span class="message-timestamp">${new Date(message.createdAt).toLocaleString()}</span>
        `;
        messageListContainer.appendChild(messageItem);

        // ìŠ¤í¬ë¡¤ì„ ë§ˆì§€ë§‰ ë©”ì‹œì§€ë¡œ ì´ë™
        messageListContainer.scrollTop = messageListContainer.scrollHeight;
    }

    // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
    function sendMessage() {
        const messageContent = document.getElementById('messageContent').value.trim();
        const messageListContainer = document.getElementById('messages'); // ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸
        if (!messageContent || !messageListContainer) {
            console.error('Required input or message list element not found.');
            return;
        }

        if (!messageContent) {
            alert("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        if (!currentRoomId) {  // currentRoomIdê°€ nullì¸ ê²½ìš°
            alert("ì±„íŒ…ë°©ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }
        // ì „ì†¡í•  ë©”ì‹œì§€ ë°ì´í„°
        const messageData = {
            content: messageContent,
            chatRoomId: currentRoomId,
            senderId: senderId,          // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ID
            receiverId: receiverId,        // ìƒí’ˆ ì†Œìœ ìì˜ ID
            senderName: senderName,      // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ì´ë¦„
            receiverName: receiverName,    // ìƒí’ˆ ì†Œìœ ìì˜ ì´ë¦„
            createdAt: new Date().toISOString(), // í˜„ì¬ ì‹œê°„
            status: 'UNREAD'                       // ë©”ì‹œì§€ëŠ” ì½ì§€ ì•Šì€ ìƒíƒœë¡œ ì„¤ì •
        };

        stompClient.send('/pub/chat/send/chatRoom', {}, JSON.stringify(messageData));

        // UI ì—…ë°ì´íŠ¸ (ë³´ë‚¸ ë©”ì‹œì§€ í‘œì‹œ)
        const messageItem = document.createElement('div');
        messageContent.value = ''; // ì…ë ¥ì°½ ì´ˆê¸°í™”
        messageListContainer.scrollTop = messageListContainer.scrollHeight; // ë§ˆì§€ë§‰ ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤
    }

    // ì±„íŒ…ë°©ì˜ ìƒëŒ€ë°© ID ë°˜í™˜
    function getReceiverIdForRoom(chatRoomId) {
        const roomData = chatRoomData.find(room => room.chatRoomId === chatRoomId);
        return roomData ? (roomData.senderId === memberId ? roomData.receiverId : roomData.senderId) : null;
    }

    // ì±„íŒ…ë°©ì˜ ìƒëŒ€ë°© ì´ë¦„ ë°˜í™˜
    function getReceiverNameForRoom(chatRoomId) {
        const roomData = chatRoomData.find(room => room.chatRoomId === chatRoomId);
        return roomData ? (roomData.senderId === memberId ? roomData.receiverName : roomData.senderName) : null;
    }

    // WebSocket ì´ˆê¸°í™” ë° ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
    function initializeWebSocket(chatRoomId) {
        if (stompClient && stompClient.connected) {
            stompClient.subscribe(`/sub/chat/${chatRoomId}`, function (messageOutput) {
                const message = JSON.parse(messageOutput.body);
                if (message.chatRoomId === currentRoomId) {
                    displayNewMessage(message);
                }
            });
            return;
        }
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            stompClient.subscribe(`/sub/chat/${chatRoomId}`, function (messageOutput) {
                const message = JSON.parse(messageOutput.body);
                if (message.chatRoomId === currentRoomId) {
                    displayNewMessage(message);
                }
            });
        });
    }
</script>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
            let productId = /*[[${product.productId}]]*/ 0; // ì œí’ˆ ID
            let images = /*[[${images}]]*/ []; // ì´ë¯¸ì§€ ë°°ì—´
            let carouselInner = document.querySelector('#imageCarousel .carousel-inner');
            let imageCountElement = document.getElementById('image-count');
            let prevButton = document.getElementById('carouselPrev');
            let nextButton = document.getElementById('carouselNext');
            let soldoutOverlay = document.getElementById('SOLDOUT-overlay');
            let resevedOverlay = document.getElementById('RESERVED-overlay');
            let csrfToken = document.querySelector('meta[name="_csrf"]').content;
            let status = /*[[${product.status}]]*/ 'NEW'; // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ìƒíƒœê°’
            // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateSoldoutStatus(status) {
                if (!soldoutOverlay) {
                    console.error("soldoutOverlay ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                if (status == 'SOLDOUT') {
                    soldoutOverlay.style.display = 'flex'; // íŒë§¤ ì™„ë£Œ ë¬¸êµ¬ í‘œì‹œ
                    document.querySelectorAll('.carousel-inner img').forEach(img => {
                        img.classList.add('SOLDOUT');
                    });
                } else {
                    soldoutOverlay.style.display = 'none'; // íŒë§¤ ì™„ë£Œ ë¬¸êµ¬ ìˆ¨ê¸°ê¸°
                    document.querySelectorAll('.carousel-inner img').forEach(img => {
                        img.classList.remove('SOLDOUT');
                    });
                }
                if (status === 'RESERVED') {
                    resevedOverlay.style.display = 'flex'; // íŒë§¤ ì˜ˆì•½ ë¬¸êµ¬ í‘œì‹œ
                    document.querySelectorAll('.carousel-inner img').forEach(img => {
                        img.classList.add('RESERVED');
                    });
                } else {
                    resevedOverlay.style.display = 'none'; // íŒë§¤ ì˜ˆì•½ ë¬¸êµ¬ ìˆ¨ê¸°ê¸°
                    document.querySelectorAll('.carousel-inner img').forEach(img => {
                        img.classList.remove('RESERVED');
                    });
                }
            }

            // íŒë§¤ ì˜ˆì•½ ë²„íŠ¼ í´ë¦­ ì‹œ ìƒíƒœ ë³€ê²½ (RESERVED <-> NEW)
            document.querySelector('#reserveButton')?.addEventListener('click', function () {
                let currentStatus = status; // í˜„ì¬ ìƒíƒœ

                if (currentStatus === 'RESERVED') {
                    // ìƒíƒœë¥¼ 'NEW'ë¡œ ë³€ê²½í•˜ê³  ì„œë²„ì— ì „ë‹¬
                    status = 'NEW';
                    updateSoldoutStatus(status); // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ

                    // ì—¬ê¸°ì„œ ì„œë²„ì— ìƒíƒœ ë³€ê²½ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤
                    // ì˜ˆì‹œ: fetch('/product/updateStatus', { method: 'POST', body: { status: 'NEW' } });
                } else if (currentStatus === 'NEW') {
                    // ìƒíƒœë¥¼ 'RESERVED'ë¡œ ë³€ê²½í•˜ê³  ì„œë²„ì— ì „ë‹¬
                    status = 'RESERVED';
                    updateSoldoutStatus(status); // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ

                    // ì—¬ê¸°ì„œ ì„œë²„ì— ìƒíƒœ ë³€ê²½ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤
                    // ì˜ˆì‹œ: fetch('/product/updateStatus', { method: 'POST', body: { status: 'RESERVED' } });
                }
            });
            updateSoldoutStatus(status);

            // ì´ë¯¸ì§€ ê°¯ìˆ˜ ì—…ë°ì´íŠ¸
            function updateImageCount(currentIndex) {
                if (images.length > 0) {
                    imageCountElement.textContent = `${currentIndex + 1} / ${images.length}`;
                } else {
                    imageCountElement.textContent = "ì´ë¯¸ì§€ê°€ ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.";
                }
            }

            // ì¹´ë¡œì…€ì— ì´ë¯¸ì§€ ì±„ìš°ê¸°
            function populateCarousel() {
                carouselInner.innerHTML = "";
                prevButton.style.display = 'none';
                nextButton.style.display = 'none';

                if (images.length > 0) {
                    images.forEach((image, index) => {
                        const carouselItem = document.createElement("div");
                        carouselItem.className = `carousel-item ${index === 0 ? "active" : ""}`;
                        carouselItem.innerHTML = `<img src="/product/display?fileName=${image.imgName}" alt="ì´ë¯¸ì§€ ${index + 1}" style="width: 300px; height: 300px;">`;
                        carouselInner.appendChild(carouselItem);
                    });

                    updateImageCount(0); // ì´ˆê¸° ì¹´ìš´íŠ¸ ì„¤ì •

                    if (images.length > 1) {
                        prevButton.style.display = 'block';
                        nextButton.style.display = 'block';
                    }
                } else {
                    const carouselItem = document.createElement("div");
                    carouselItem.className = "carousel-item active";
                    carouselItem.innerHTML = `<img src="/images/default.png" class="d-block w-100" alt="ê¸°ë³¸ ì´ë¯¸ì§€" style="width: 100%; height: 100%;">`;
                    carouselInner.appendChild(carouselItem);

                    updateImageCount(0);
                }

                // ì¹´ë¡œì…€ ì´ë¯¸ì§€ ë³€ê²½ ì´ë²¤íŠ¸ì— í•¸ë“¤ëŸ¬ ì¶”ê°€
                const carouselElement = document.querySelector("#imageCarousel");
                carouselElement.addEventListener("slid.bs.carousel", function (event) {
                    const activeIndex = Array.from(carouselInner.children).findIndex(item => item.classList.contains("active"));
                    updateImageCount(activeIndex);
                });
            }

            let buyButton = document.querySelector('.buy-button a');
            if (buyButton) {
                buyButton.addEventListener('click', function (e) {
                    e.preventDefault(); // ê¸°ë³¸ ë§í¬ í´ë¦­ ë™ì‘ ë°©ì§€

                    // ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸
                    fetch('/check-login', { // ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    })
                        .then(response => response.json())
                        .then(data => {
                            let url1 = '/member/login';
                            // ë¡œê·¸ì¸ ëœ ê²½ìš°ì—ë§Œ êµ¬ë§¤ ì™„ë£Œ ì²˜ë¦¬
                            let url = '/product/complete/' + productId;
                            fetch(url, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRF-TOKEN': csrfToken,  // CSRF í† í° ì¶”ê°€
                                },
                            })
                                .then(response => response.json()) // JSON ì‘ë‹µ ì²˜ë¦¬
                                .then(data => {
                                    if (data.status === 'success') {
                                        alert(data.message);
                                        updateSoldoutStatus(true);  // íŒë§¤ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½
                                        // êµ¬ë§¤ ì™„ë£Œ í›„ í•´ë‹¹ URLë¡œ ì´ë™
                                        window.location.href = url;
                                    } else {
                                        alert(data.message);
                                    }
                                })
                                .catch(error => {
                                    window.location.href = url1;
                                });
                        })
                        .catch(error => {
                            console.error('ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
                            alert('ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        });
                    window.location.href = url1;
                });
            }


            populateCarousel();  // ì¹´ë¡œì…€ ì´ë¯¸ì§€ ì´ˆê¸°í™”
        }
    );

        // ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” ë³€ìˆ˜ ì •ì˜
    let isLoggedIn = /*[[${authDTO != null}]]*/ true;

    function toggleFavorite(productId, isFavorited) {
        if (!isLoggedIn) {
            alert("ë¡œê·¸ì¸ í›„ ì°œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;  // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° ê¸°ëŠ¥ ì‹¤í–‰ ì¤‘ì§€
        }

        if (isFavorited == null) {
            isFavorited = false;  // ê¸°ë³¸ê°’ ì²˜ë¦¬
        }

        let url = '/product/favorite/' + productId; // ì°œ ìƒíƒœ í† ê¸€ì„ ìœ„í•œ ë™ì¼í•œ ì—”ë“œí¬ì¸íŠ¸

        console.log("URL to fetch: " + url);  // ìš”ì²­ URL í™•ì¸

        // CSRF í† í°ì„ meta íƒœê·¸ì—ì„œ ì½ì–´ì˜¤ê¸°
        let csrfToken = document.querySelector('meta[name="_csrf"]').content;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrfToken,  // CSRF í† í° ì¶”ê°€
            },
        })
            .then(response => response.json())
            .then(data => {
                const icon = document.getElementById('fav-icon-' + productId);
                const count = document.querySelector(`#fav-icon-${productId} + span`);

                // ì°œ ìƒíƒœì— ë”°ë¼ í•˜íŠ¸ ì•„ì´ì½˜ ì´ë¯¸ì§€ ë³€ê²½
                if (data.isFavorited) {
                    icon.src = '/images/like.png';  // ì°œ ìƒíƒœì¼ ë•Œ
                } else {
                    icon.src = '/images/notlike.png';  // ì°œí•˜ì§€ ì•Šì•˜ì„ ë•Œ
                }
                // ì°œí•œ ì‚¬ìš©ì ìˆ˜ ê°±ì‹ 
                count.textContent = data.favoriteCount;

                console.log('Response Data:', data); // ì„œë²„ ì‘ë‹µ ë°ì´í„° í™•ì¸
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
</script>
</html>
